---
layout: post
title: Sendmail
---

# Links
- [qmail.jms1.net](https://qmail.jms1.net/test-auth.shtml)
- [BSD Handbook](http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/SMTP-Auth.html)
- [Sendmail.org](http://www.sendmail.org/~ca/email/auth.html)

# Testing mailserver
This expects you to have netcat, perl and openssl installed

## Hello without TLS
<pre>
<b>nc mail.server.com 25</b>
220 mail.server.com ESMTP Sendmail 8.14.7/8.14.7; Thu, 11 Sep 2014 12:01:22 +0200 (CEST)
<b>ehlo friendly.server.com</b>
250-mail.server.com Hello friendly [1.2.3.4], pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE
250-DSN
250-ETRN
250-AUTH DIGEST-MD5 CRAM-MD5
250-STARTTLS
250-DELIVERBY
250 HELP
<b>quit</b>
221 2.0.0 mail.server.com closing connection
</pre>

## Hello with TLS
<pre>
<b>openssl s_client -starttls smtp -crlf -connect mail.server.com:25</b>
# ...Loads of text here...
<b>ehlo friendly.server.com</b>
# ... Same as login without TLS (above) ...
</pre>

## Test login
<pre>
<b>perl -MMIME::Base64 -e 'print encode_base64("\000coolname\@iix.se\000my-password")'</b>
AGNvb2xuYW1lQGlpeC5zZQBteS1wYXNzd29yZA==
# .. Log in to server with one of the above ...
<b>AUTH PLAIN AGNvb2xuYW1lQGlpeC5zZQBteS1wYXNzd29yZA==</b>
235 2.0.0 OK Authenticated
<b>quit</b>
221 2.0.0 mail.server.com closing connection
</pre>

## Sending mail
<pre>
<b>mail from: &lt;nospam@jms1.net&gt;</b>
250 ok
<b>rcpt to: &lt;nospam@jms1.net&gt;</b>
250 ok
<b>data</b>
354 go ahead
<b>From: John &lt;nospam@jms1.net&gt;
To: Nobody &lt;nospam@jms1.net&gt;
Subject: fnord

hail eris!
.</b>
250 ok 1113954693 qp 29052
<b>quit</b>
</pre>


# Activating SMTP AUTH (PLAIN) through STARTTLS in sendmail @ FreeBSD
N.B. This expects a working sendmail installation with STARTTLS  

## Install cyrus-sasl
{% highlight bash %}
# install cyrus-sasl2
cd /usr/ports/security/cyrus-sasl2
make install clean
echo "pwcheck_method: saslauthd" > /usr/local/lib/sasl2/Sendmail.conf

# install cyrus-sasl2-saslauthd
cd /usr/ports/security/cyrus-sasl2-saslauthd
make install clean
echo 'saslauthd_enable="YES"' >> /etc/rc.conf
service saslauthd start
{% endhighlight %}

## Set sendmail make flags
Set the following flags in /etc/make.conf (create if it doesn't exist)
{% highlight make %}
SENDMAIL_CFLAGS=-I/usr/local/include/sasl -DSASL
SENDMAIL_LDFLAGS=-L/usr/local/lib
SENDMAIL_LDADD=-lsasl2
{% endhighlight %}

## Recompile sendmail
Did you have the source in /usr/src? Otherwise you will need to run
the following command. If you don't use RELEASE-10, you should change that.
{% highlight bash %}
svnlite checkout http://svn.freebsd.org/base/release/10.0.0/ /usr/src
{% endhighlight %}
Now recompile sendmail
{% highlight bash %}
cd /usr/src/lib/libsmutil
make cleandir && make obj && make
cd /usr/src/lib/libsm
make cleandir && make obj && make
cd /usr/src/usr.sbin/sendmail
make cleandir && make obj && make && make install
{% endhighlight %}

## Do some config switcheroo
Fetch a sendmail config if you don't already have one
{% highlight bash %}
cd /etc/mail
make
{% endhighlight %}
Now you should have a your-hostname.mc file. If you DON'T want AUTH PLAIN,
you can simply add the following lines
{% highlight bash %}
dnl set SASL options
TRUST_AUTH_MECH(`GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN')dnl
define(`confAUTH_MECHANISMS', `GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN')dnl
{% endhighlight %}
If you DO want AUTH PLAIN, add these instead
{% highlight bash %}
dnl Set SASL options
dnl Only allow AUTH LOGIN PLAIN through STARTTLS and disallow anons
dnl
define(`confAUTH_OPTIONS', `A p y')dnl
TRUST_AUTH_MECH(`GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN PLAIN')dnl
define(`confAUTH_MECHANISMS', `GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN PLAIN')dnl
{% endhighlight %}

Now install them and restart sendmail
{% highlight bash %}
make install restart
{% endhighlight %}
